<script setup>
import { ref, onMounted, onBeforeUnmount, nextTick } from "vue";
import SockJS from "sockjs-client";
import { Client } from "@stomp/stompjs";
import { OpenVidu } from "openvidu-browser";
import ClientFrame from "@/components/layout/client/ClientFrame.vue";
import axios from "axios";
import { useRoute } from "vue-router";

const route = useRoute();
const scheduleNo = route.query.scheduleNo;

const OV = ref(null);
const session = ref(null);
const publisher = ref(null);
const videoContainer = ref(null);

const preventReload = (e) => {
  e.preventDefault();
  e.returnValue = "";
};

const initPublisherWithDelay = async () => {
  await nextTick(); // DOM 안정화
  publisher.value = await OV.value.initPublisherAsync(videoContainer.value, {
    videoSource: undefined,
    audioSource: undefined,
    publishAudio: true,
    publishVideo: true,
    resolution: '640x480',
    frameRate: 30,
    insertMode: 'APPEND',
    mirror: false
  });

  publisher.value.on('videoElementCreated', (event) => {
    requestAnimationFrame(() => {
      const video = event.element;
      video.style.width = '100%';
      video.style.height = '100%';
      video.style.objectFit = 'cover';
      video.style.border = "2px solid red";
      video.style.borderRadius = '0.5rem';
    });
  });

  if (publisher.value) {
    await session.value.publish(publisher.value);
    console.log('✅ 방송 송출 시작됨');
  }
};

const connectSession = async () => {
  try {
    const saved = localStorage.getItem("currentBroadcast");
    if (saved) {
      const parsed = JSON.parse(saved);
      console.log("🧷 저장된 세션 복구됨:", parsed);
      await reconnectBroadcast(parsed.sessionId);
      return;
    }

    const res = await axios.post('/api/lawyer/broadcast/start', {
      scheduleNo: Number(scheduleNo),
    });
    const { sessionId, token } = res.data;

    console.log('📡 방송자 sessionId:', sessionId);
    console.log('🔑 방송자 token:', token);

    localStorage.setItem("currentBroadcast", JSON.stringify({ sessionId, scheduleNo }));

    OV.value = new OpenVidu();
    session.value = OV.value.initSession();

    session.value.on('exception', (exception) => {
      console.warn('OpenVidu 예외 발생:', exception);
    });
    session.value.on('sessionDisconnected', (event) => {
      console.warn('세션 연결 종료:', event.reason);
    });

    await session.value.connect(token);
    await initPublisherWithDelay();

  } catch (e) {
    console.error('❌ [방송자] 연결 오류:', e);
  }
};

const reconnectBroadcast = async (existingSessionId) => {
  try {
    const { data } = await axios.get(`/api/lawyer/broadcast/reconnect/${existingSessionId}`);
    const { token } = data;

    OV.value = new OpenVidu();
    session.value = OV.value.initSession();

    session.value.on('exception', (exception) => {
      console.warn('OpenVidu 예외 발생:', exception);
    });

    await session.value.connect(token);
    await initPublisherWithDelay();

  } catch (err) {
    console.error("❌ 재접속 실패:", err);
    localStorage.removeItem("currentBroadcast");
  }
};

onMounted(() => {
  window.addEventListener("beforeunload", preventReload);
  if (scheduleNo) {
    connectSession();
  } else {
    alert("방송 스케줄 번호가 유효하지 않습니다.");
  }
  connect();
});

onBeforeUnmount(() => {
  window.removeEventListener("beforeunload", preventReload);
  stompClient.value?.deactivate();
  closeDropdown();
  session.value?.disconnect();
});



// --- 채팅 WebSocket 관련 ---
const stompClient = ref(null);
const randomNickname = () => "유저" + Math.floor(1000 + Math.random() * 9000);
const nickname = randomNickname();
const broadcastNo = route.params.broadcastNo;
const message = ref("");
const messages = ref([]);
const messageContainer = ref(null);

const nicknameColors = ref({});
const colorPalette = [
  "#1abc9c", "#034335", "#84ddaa", "#450978",
  "#184563", "#8bc2e4", "#c791dd", "#8e44ad",
  "#837225", "#876124", "#004aff", "#ff6400",
  "#ec8d85", "#c0392b", "#246667", "#e4de0d"
];
function getRandomColor() {
  return colorPalette[Math.floor(Math.random() * colorPalette.length)];
}
function getNicknameColor(nick) {
  if (!nicknameColors.value[nick]) {
    nicknameColors.value[nick] = getRandomColor();
  }
  return nicknameColors.value[nick];
}

const dropdownIdx = ref(null);
const selectedUser = ref(null);
const selectedMessage = ref(null);
const isConfirmModal = ref(false);
const isCompleteModal = ref(false);

const connect = () => {
  stompClient.value = new Client({
    webSocketFactory: () => new SockJS("http://localhost:8080/ws"),
    reconnectDelay: 5000,
    onConnect: () => {
      stompClient.value.subscribe(
          `/topic/${broadcastNo}`,
          (msg) => {
            const data = JSON.parse(msg.body);
            messages.value.push(data);
            scrollToBottom();
          }
      );
      stompClient.value.publish({
        destination: "/app/chat.addUser",
        body: JSON.stringify({ broadcastNo, nickname })
      });
    },
    onStompError: (frame) => {
      console.error("STOMP error:", frame);
    }
  });
  stompClient.value.activate();
};

const sendMessage = () => {
  const trimmed = message.value.trim();
  if (!trimmed || !stompClient.value?.connected) return;
  stompClient.value.publish({
    destination: "/app/chat.sendMessage",
    body: JSON.stringify({ broadcastNo, nickname, message: trimmed })
  });
  message.value = "";
  scrollToBottom();
};

const scrollToBottom = () => {
  nextTick(() => {
    if (messageContainer.value) {
      messageContainer.value.scrollTop = messageContainer.value.scrollHeight;
    }
  });
};

const openDropdown = (idx, msg) => {
  if (msg.nickname === nickname) return;
  dropdownIdx.value = idx;
  selectedUser.value = msg.nickname;
  selectedMessage.value = msg.message;
  setTimeout(() => {
    window.addEventListener("mousedown", onWindowClick);
  }, 0);
};
const closeDropdown = () => {
  dropdownIdx.value = null;
  window.removeEventListener("mousedown", onWindowClick);
};
const onWindowClick = (e) => {
  if (!e.target.closest(".nickname-dropdown")) closeDropdown();
};

const onReportClick = () => {
  isConfirmModal.value = true;
  closeDropdown();
};
const confirmReport = async () => {
  try {
    await axios.post("/api/chat/report", {
      userNo: 1,
      nickname: selectedUser.value,
      message: selectedMessage.value,
    });
  } catch (e) {}
  isConfirmModal.value = false;
  isCompleteModal.value = true;
};
const closeCompleteModal = () => {
  isCompleteModal.value = false;
};
</script>


<template>
  <ClientFrame>
    <div class="position-relative w-100 vh-100">
      <div class="position-absolute top-0 start-0 bg-dark shadow rounded d-flex flex-column" style="width: calc(100% - 480px); margin: 2rem;">
        <!-- 방송 영상 영역 -->
        <div ref="videoContainer" style="height: 520px;" class="rounded-top"></div>

        <!-- 방송 정보 영역 -->
        <div class="bg-light text-dark p-7 rounded-bottom">
          <!-- 제목 + 키워드 -->
          <div class="d-flex justify-content-between align-items-start mb-3">
            <h2 class="fs-3 fw-bold mb-0">{{ scheduleInfo.name }}</h2>
            <div>
          <span
              v-for="(keyword, index) in scheduleInfo.keywords"
              :key="index"
              class="badge bg-primary me-1 fs-6"
          >#{{ keyword }}</span>
            </div>
          </div>

          <!-- 변호사 정보 -->
          <div class="d-flex align-items-center mt-5">
            <img
                :src="lawyerProfileImg"
                alt="변호사 프로필"
                class="rounded-circle me-3"
                style="width: 75px; height: 75px; border: 3px solid #15ea7e;"
            />
            <div class="fs-5 fw-bold">{{ lawyerName }}</div>
          </div>
        </div>
      </div>
    </div>

    <div class="position-absolute border rounded shadow p-4 d-flex flex-column" style="width: 400px; height: 700px; top: 2rem; right: 2rem;">
        <div ref="messageContainer" class="flex-grow-1 overflow-auto mb-3 scroll-hidden" style="scroll-behavior: smooth;">
          <div v-for="(msg, index) in messages" :key="index" class="mb-3" style="position:relative;">
            <div v-if="msg.type === 'ENTER'" class="w-100 text-center" style="color: #435879; font-size: 0.9rem;">
              {{ msg.message }}
            </div>
            <div v-else style="font-size: 1.0rem; font-weight: bold; display:flex; align-items:center;">
              <span @click.stop="msg.nickname !== nickname && openDropdown(index, msg)"
                    :style="{
                      color: getNicknameColor(msg.nickname),
                      cursor: msg.nickname !== nickname ? 'pointer' : 'default',
                      userSelect: 'text',
                      position: 'relative',
                      fontWeight: 'bold'
                    }">
                {{ msg.nickname }}
                <span v-if="dropdownIdx === index && msg.nickname !== nickname" class="nickname-dropdown" style="position:absolute;top:120%;left:0;z-index:10000;">
                  <ul class="dropdown-custom-menu">
                    <li class="menu-report" @click.stop="onReportClick">
                      🚨 메시지 신고 🚨
                    </li>
                  </ul>
                </span>
              </span>
              <span style="margin-left:0.6em;">: {{ msg.message }}</span>
            </div>
          </div>
        </div>
        <div class="d-flex">
          <input v-model="message" type="text" class="form-control me-2" placeholder="메시지를 입력하세요" @keyup.enter="sendMessage" />
        </div>
      </div>

      <div v-if="isConfirmModal" class="modal-overlay-dark">
        <div class="modal-custom-box">
          <div class="modal-custom-content">
            <div class="modal-custom-msg">
              <div class="modal-custom-text">
                <strong>{{ selectedUser }}</strong>님의 메시지를 신고하시겠습니까?<br />
                <p class="fw-light">신고된 메시지는 처리를 위해 수집됩니다.</p>
                <span style="font-size:0.9rem; color:#888;">"{{ selectedMessage }}"</span>
              </div>
            </div>
            <div class="modal-custom-btns">
              <button class="modal-btn-cancel" @click="isConfirmModal=false">취소</button>
              <button class="modal-btn-ok" @click="confirmReport">확인</button>
            </div>
          </div>
        </div>
      </div>

      <div v-if="isCompleteModal" class="modal-overlay-dark">
        <div class="modal-custom-box">
          <div class="modal-custom-content">
            <div class="modal-custom-msg">
              <div class="modal-custom-text" style="text-align:center;">
                메시지 신고가 정상 접수되었습니다.<br />
                가이드 위반 유무 검토 후 조치 예정입니다.<br />
                감사합니다.
              </div>
            </div>
            <div class="modal-custom-btns">
              <button class="modal-btn-ok" @click="closeCompleteModal">확인</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ClientFrame>
</template>

<style scoped>
.scroll-hidden::-webkit-scrollbar { display: none; }
.scroll-hidden { -ms-overflow-style: none; }
.dropdown-custom-menu {
  background: #232428;
  color: #dedede;
  border-radius: 10px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.24);
  min-width: 190px;
  padding: 8px 0;
  margin: 0;
  list-style: none;
  border: 1px solid #282a30;
  font-size: 1.07rem;
}
.dropdown-custom-menu li {
  display: flex;
  align-items: center;
  padding: 10px 22px;
  cursor: pointer;
  transition: background 0.13s;
  gap: 10px;
  font-weight: 500;
}
.dropdown-custom-menu li:hover { background: #2d2f34; }
.dropdown-custom-menu .menu-report {
  color: #fd6262;
  background: #26272b;
}
.dropdown-custom-menu .menu-report:hover { background: #33292c; }
.modal-overlay-dark {
  position: fixed; top:0; left:0; width:100vw; height:100vh;
  background: rgba(18, 19, 21, 0.85);
  display: flex; align-items: center; justify-content: center;
  z-index: 9999;
}
.modal-custom-box {
  background: white;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.28);
  min-width: 360px;
  padding: 0;
  overflow: hidden;
  color: black;
}
.modal-custom-content { padding: 36px 36px 24px 36px; }
.modal-custom-msg { margin-bottom: 34px; }
.modal-custom-text { font-size: 1.14rem; line-height: 1.7; font-weight: 600; }
.modal-custom-btns {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 18px;
}
.modal-btn-cancel, .modal-btn-ok {
  padding: 0 0;
  border: none;
  outline: none;
  border-radius: 8px;
  font-size: 1.07rem;
  font-weight: 600;
  height: 48px;
  min-width: 128px;
  cursor: pointer;
  transition: background 0.13s, color 0.12s;
}
.modal-btn-cancel {
  background: #f47e4a;
  color: #ffffff;
}
.modal-btn-cancel:hover { background: #efb485; }
.modal-btn-ok {
  background: #435879;
  color: #ffffff;
}
.modal-btn-ok:hover { background: #7d8bbd; }
</style>
