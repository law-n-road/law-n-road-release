<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lawnroad.template.mapper.ClientTemplateMapper">
    <!-- 전체 템플릿 목록 조회 -->
    <select id="selectAllTemplates" resultType="com.lawnroad.template.dto.TemplateDto">
        SELECT
        t.no,
        t.user_no        AS userNo,
        t.category_no    AS categoryNo,
        t.type,
        c.name           AS category_name,
        t.name,
        t.price,
        t.discount_rate,
        t.sales_count,
        t.thumbnail_path,
        t.sales_count,
        t.created_at
        FROM template t
        LEFT JOIN category c ON t.category_no = c.no
        WHERE t.is_deleted = 0
        <if test="categoryNo != null">AND t.category_no = #{categoryNo}</if>
        <if test="keyword != null and keyword != ''">AND t.name LIKE CONCAT('%', #{keyword}, '%')</if>
        <if test="tag != null and tag != ''">
            <choose>
                <when test="tag == 'free'">AND t.price = 0</when>
                <when test="tag == 'special'">AND t.discount_rate &gt;= 20</when>
                <when test="tag == 'ai'">AND t.type = 'EDITOR'</when>
                <when test="tag == 'file'">AND t.type = 'FILE'</when>
            </choose>
        </if>
        ORDER BY
        <choose>
            <when test="sort == 'popular'">t.sales_count DESC</when>
            <when test="sort == 'priceAsc'">t.price ASC</when>
            <when test="sort == 'priceDesc'">t.price DESC</when>
            <otherwise>t.created_at DESC</otherwise>
        </choose>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 전체 템플릿 총 개수 -->
    <select id="countAllTemplates" resultType="int">
        SELECT COUNT(*)
        FROM template t
        WHERE t.is_deleted = 0
        <if test="categoryNo != null">AND t.category_no = #{categoryNo}</if>
        <if test="keyword != null and keyword != ''">AND t.name LIKE CONCAT('%', #{keyword}, '%')</if>
        <if test="tag != null and tag != ''">
            <choose>
                <when test="tag == 'free'">AND t.price = 0</when>
                <when test="tag == 'special'">AND t.discount_rate &gt;= 30</when>
                <when test="tag == 'ai'">AND t.type = 'EDITOR'</when>
                <when test="tag == 'file'">AND t.type = 'FILE'</when>
            </choose>
        </if>
    </select>

    <!-- 제품 상세조회 -->
    <select id="selectTemplateDetailByNo"
            parameterType="long"
            resultType="com.lawnroad.template.dto.ClientTemplateDetailResponseDto">
        SELECT
            t.no,
            t.name,
            t.price,
            t.discount_rate,
            c.name              AS category_name,
            t.type,
            t.thumbnail_path,
            t.sales_count,
            t.description,
            l.name              AS lawyer_name,
            l.profile           AS profile,
            l.road_address      AS road_address,
            l.land_address      AS land_address,
            l.detail_address    AS detail_address,
            l.office_number     AS office_number,

            ''                  AS short_intro,
            ''                  AS long_intro
        FROM template t
                 LEFT JOIN category c ON t.category_no = c.no
                 LEFT JOIN lawyer   l ON t.user_no     = l.no
        WHERE t.no = #{templateNo}
    </select>

</mapper>