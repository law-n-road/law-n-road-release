<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lawnroad.template.mapper.TemplateMapper">

    <resultMap id="templateListMap" type="com.lawnroad.template.dto.TemplateListDto">
        <id property="no" column="no"/>
        <result property="category_name" column="category_name"/>
        <result property="name" column="name"/>
        <result property="price" column="price"/>
        <result property="discount_rate" column="discount_rate"/>
        <result property="sales_count" column="sales_count"/>
        <result property="created_at" column="created_at"/>
        <result property="thumbnail_path" column="thumbnail_path"/>
    </resultMap>

    <resultMap id="templateResultMap" type="com.lawnroad.template.dto.TemplateDto">
        <id property="no" column="no"/>
        <result property="name" column="name"/>
        <result property="price" column="price"/>
        <result property="discount_rate" column="discount_rate"/>
        <result property="description" column="description"/>
        <result property="template_path" column="template_path"/>
        <result property="thumbnail_path" column="thumbnail_path"/>
        <result property="created_at" column="created_at"/>
        <result property="sales_count" column="sales_count"/>
        <result property="category_name" column="category_name"/>
    </resultMap>

    <!-- 공통 전체 조회 -->
    <select id="findAll" resultMap="templateListMap">
        SELECT
        t.no AS no,
        c.name AS category_name,
        t.name AS name,
        t.price AS price,
        t.discount_rate AS discount_rate,
        t.sales_count AS sales_count,
        t.created_at AS created_at,
        t.thumbnail_path AS thumbnail_path
        FROM template t
        INNER JOIN category c ON t.category_no = c.no
        WHERE t.is_deleted = 0
        ORDER BY t.created_at DESC
    </select>

    <!-- 공통 상세 조회 -->
    <select id="findByNo" resultMap="templateResultMap">
        SELECT
        t.no,
        t.name,
        t.price,
        t.discount_rate,
        t.description,
        t.template_path,
        t.thumbnail_path,
        t.created_at,
        t.sales_count,
        c.name AS category_name
        FROM template t
        INNER JOIN category c ON t.category_no = c.no
        WHERE t.no = #{no}
        AND t.is_deleted = 0
    </select>

    <!-- 사용자용 전체 구매 템플릿 조회 -->
    <select id="findByUserNo" resultType="com.lawnroad.template.dto.TemplateListDto">
        SELECT t.*
        FROM template t
        JOIN tmpl_orders_history toh ON toh.tmpl_no = t.no
        JOIN orders o ON o.no = toh.order_no
        WHERE o.user_no = #{userNo}
        AND t.is_deleted = 0
    </select>

    <!-- 사용자용 상세 구매 템플릿 조회 -->
    <select id="findByNoAndUserNo" resultType="com.lawnroad.template.dto.TemplateDto">
        SELECT t.*
        FROM template t
        JOIN tmpl_orders_history toh ON toh.tmpl_no = t.no
        JOIN orders o ON o.no = toh.order_no
        WHERE t.no = #{no}
        AND o.user_no = #{userNo}
        AND t.is_deleted = 0
    </select>

    <!-- 변호사용 전체 등록 템플릿 조회 -->
    <select id="findByLawyerNo" resultMap="templateListMap">
        SELECT
        t.no, c.name AS category_name, t.name, t.price,
        t.discount_rate, t.sales_count, t.created_at, t.thumbnail_path
        FROM template t
        INNER JOIN category c ON t.category_no = c.no
        WHERE t.user_no = #{lawyerNo}
        AND t.is_deleted = 0
        ORDER BY t.created_at DESC
    </select>

    <!-- 변호사용 단일 템플릿 조회 -->
    <select id="findByNoAndLawyerNo" resultType="com.lawnroad.template.dto.TemplateDto">
        SELECT *
        FROM template
        WHERE no = #{no}
        AND user_no = #{lawyerNo}
        AND is_deleted = 0
    </select>

    <!-- 변호사용 템플릿 등록 -->
    <insert id="insert">
        INSERT INTO template (
        user_no, category_no, name, description,
        price, template_path, thumbnail_path,
        discount_rate, sales_count, is_deleted,
        created_at, updated_at
        )
        VALUES (
        #{dto.user_no}, #{dto.category_no}, #{dto.name}, #{dto.description},
        #{dto.price}, #{dto.template_path}, #{dto.thumbnail_path},
        #{dto.discount_rate}, 0, 0, NOW(), NOW()
        )
    </insert>

    <!-- 변호사용 템플릿 수정 -->
    <update id="update">
        UPDATE template
        SET
        category_no = #{dto.category_no},
        name = #{dto.name},
        description = #{dto.description},
        price = #{dto.price},
        template_path = #{dto.template_path},
        thumbnail_path = #{dto.thumbnail_path},
        discount_rate = #{dto.discount_rate},
        updated_at = NOW()
        WHERE no = #{no}
        AND user_no = #{lawyerNo}
        AND is_deleted = 0
    </update>

    <!-- 변호사용 소프트 딜리트 -->
    <update id="delete">
        UPDATE template
        SET is_deleted = 1,
        updated_at = NOW()
        WHERE no = #{no}
        AND user_no = #{lawyerNo}
    </update>

</mapper>
